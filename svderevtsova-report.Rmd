---
title: 'HW1: airports&airlines'
author: "Деревцова Софья, svderevtsova"
date: '2022-11-06'
output: html_document
---
## Задача
  
на основе данных (и выданных вопросов) постараться выяснить:
  
  * какие проблемы есть в авиаперевозках
* какие улучшения можно предложить на основе выводов по данным

#### Загрузка данных и преобразование

```{r message = FALSE, warning=FALSE, echo = F}
library(dplyr)
library(ggplot2)
library(readr)
library(lubridate)
library(stringr)

source("~/shared/minor2_2022/1-Intro/hw1/hw1_data.R")

airline = hw1_get_data(df_name = "airline")
airport = hw1_get_data(df_name = "airport")
lounge = hw1_get_data(df_name = "lounge")
seat = hw1_get_data(df_name = "seat")

hw1_get_questions()
```
### Преобразование данных 
В общем и целоом, нам необходимо облегчить работу с датасетами, чтбы было легче производить анализ данных. Для этого мы преобразуем даты, чтобы иметь возможность при необходимости получить информацию формата месяц/день/год и иметь возможность фильтровать данные по этой информации.  Далее описаны более подробные преобразования по датасетам. 

#### Датасет airline
- преобразуем информацию из столбца date как дату
- значения из столбца recommended сделаем логическими переменными 

#### Датасеты airport
- отразим информацию из столбцов date и date_visit как дату
- значения из столбца recommended сделаем логическими переменными
- также сделаем значением типа factor значения из столбца, содержащего информацию о стране автора (author_country)

#### Датасет lounge
- отразим информацию из столбцов date и date_visit как дату
- значения из столбца recommended сделаем логическими переменными

#### Датасет seat
- преобразуем информацию из столбцов date и date_flown как дату
- значения из столбца recommended сделаем логическими переменными

```{r message = FALSE, warning=FALSE, echo = F}
airline$date = as_date(airline$date)
airline$recommended = as.logical(airline$recommended)

airport$date = as_date(airport$date)
airport$date_visit = as_date(airport$date_visit)
airport$recommended = as.logical(airport$recommended)

lounge$date = as_date(lounge$date)
lounge$date_visit = as_date(lounge$date_visit)

seat$date = as_date(seat$date)
seat$date_flown = as_date(seat$date_flown)
seat$recommended = as.logical(seat$recommended)
```


### Вопросы

#### Вопрос 1

**Вопрос:** Люди из каких стран ниже всего оценивают wi-fi в аэропортах?
  
  **Данные:** для ответа на вопрос нужна таблица airport, в которой содержится столбец с информацией об оценке, поставленной wi-fi соединению в аэропорту и сттолбец с данными о стране, в которой проживает автор оценки

```{r message = FALSE, warning=FALSE, echo = F, include=FALSE}
library(forcats)
q1 = filter(airport, !is.na(wifi_connectivity_rating))
q1 = q1 %>% group_by(author_country) %>% summarise(mean_wifi_rating = mean(wifi_connectivity_rating)) %>% arrange(desc(mean_wifi_rating))
ggplot(data = q1) + geom_col(aes(x = fct_reorder(author_country, mean_wifi_rating), y = mean_wifi_rating), fill = "darkblue", color = "white", alpha = 0.7) +
  coord_flip() +
  ggtitle("Средние оценки качества wi-fi в аэропортах\nв зависимости от страны автора отзыва") + 
  xlab("страна") + 
  ylab("средняя оценка")

```

**Ответ:**
```{r echo = F}
ggplot(data = filter(q1, mean_wifi_rating <= 1)) + geom_col(aes(x = fct_reorder(author_country, mean_wifi_rating), y = mean_wifi_rating), fill = "darkblue", color = "white", alpha = 0.7) +
  coord_flip() +
  ggtitle("топ-6 стран с самыми низкими средними\nоценками wi-fi в аэропортах") + 
  xlab("страна") + 
  ylab("средняя оценка")
```



**Вывод:** Во-первых, стоит отметить, что информация в датасете не является полной, так как лишь очень маленькое число авторов дали оценку качеству wi-fi в аэропорту: после отбора лишь значимых данных у нас осталось 28 отзывов, хотя сначала их было 1001. В итоговой таблице осталось 18 строк, то есть средние оценки имеются по 18 странам. Так как всего было 28 отзывов, а стран 18, то мы можем понять, что средняя оценка по некоторым странам складывается из оценки одного конкретного пользователя. Таким образом, выводы о качестве wi-fi и взаимосвязи оценки пользователя с его страной, основанные на исходном датасете не могут быть до конца объективными в виду недостатка данных. Главный вывод после анализа информации заключается в том, что только менее 3% авторов дали оценку качеству wi-fi, что является достаточно маленьким числом. Далее можно заметить, что в среднем, жители европейских стран менее удовлетворены качеством интернета, нежели пассажиры из России, Новой Зеландии, Австралии, Пакистана и Китая. Чтобы получить более полную информацию и понимать, существует ли проблема с wi-fi соединением в аэропорту можно предложить пассажирам ставить оценку интернет соединению во время использования wi-fi в аэропорту. Это позволит получить большую выборку, что значительно улучшит понимание ситуации. Исходя из анализа полученной информации, можно будет предлагать варианты решения проблемы с интернетом (если она вообще будет существовать).  

#### Вопрос 2

**Вопрос:** В каких самолетах более высокие оценки удобства пространства для ног — те, в которых два прохода или один?
  
  **Данные:** для ответа на вопрос нужны таблицы seat

```{r message = FALSE, warning=FALSE, echo = F}
q2= mutate(seat, passages_qty = str_count(seat$seat_layout, "x|X|-"))
q2 = filter(q2, passages_qty > 0)
q2$passages_qty = as.factor(q2$passages_qty)

q2_res = q2 %>% group_by(passages_qty) %>% summarise(mean_legroom_rating = mean(seat_legroom_rating)) %>% arrange(desc(mean_legroom_rating))

two_passages = filter(q2, passages_qty == 2)
one_passage = filter(q2, passages_qty == 1)

q2$seat_legroom_rating = as.factor(q2$seat_legroom_rating)

```


```{r echo = F}
knitr::kable(q2_res, format = "html", digits = 3, col.names = c('qty of passages |', '| mean legroom rating'), align = "cc")
```



```{r echo = F}
ggplot(data = two_passages) + geom_bar(aes(x = seat_legroom_rating), fill = "darkblue", color = "white", alpha = 0.7) +
  ggtitle("распределение оценок удобства пространства для ног среди\nсамолетов с двумя проходами") + 
  xlab("рейтинг(оценка)") + 
  ylab("количество оценок") +
  geom_vline(xintercept = mean(two_passages$seat_legroom_rating))
```

```{r echo = F}
ggplot(data = one_passage) + geom_bar(aes(x = seat_legroom_rating), fill = "darkblue", color = "white", alpha = 0.7) +
  ggtitle("распределение оценок удобства пространства для ног среди\nсамолетов с одним проходом") + 
  xlab("рейтинг(оценка)") + 
  ylab("количество оценок") +
  geom_vline(xintercept = mean(one_passage$seat_legroom_rating))
```
```{r echo=FALSE}
ggplot(data = q2) + geom_bar(aes(x = passages_qty, fill = seat_legroom_rating)) +
  ggtitle("распределение оценок удобства пространства для ног среди\nсамолетов с двумя проходами") + 
  xlab("количество проходов") + 
  ylab("количество оценок") +
  theme_minimal()

```

**Ответ:**  более высокие оценки удобства пространства для ног в самолетах с 2 проходами

**Вывод:** Из исходного датасета была удалена лишь одна запись, которая не давала информации оо количестве проходов в самолете, что не могло оказать большого влияния на результаты. Согласно анализу оценок можно выявить закономерность, которая заключается в том, что самолеты с двумя проходами имеют более высокие оценки удобства пространства для ног, нежели самолеты с одним проходом. Если авиакомпании хотят улучшить отзывы, то им необходимо увеличить пространство для ног в самолетах с одним проходом так, чтобы оно было не меньше этого расстояния в самолетах с тремя рядами кресел. Однако мы также видим, что хотя средняя оценка удобства пространства для ног отличается, это разница не кардинальна, так что стоит также допускать возможность погрешности. Возможно стоит также проанализировать, зависит ли оценка удобства пространства для ног от длительности полета, так как если человек долго находится в кресле, то он устает и, вероятно, более склонен поставить оценку ниже.  

#### Вопрос 3

**Вопрос:** Какие лаунж-зоны оценены по чистоте (cleanliness) выше, чем аэропорты, в которых они расположены?
  
**Данные:** для ответа на вопрос нужны таблицы lounge, airport

```{r echo = F, message=FALSE, warning=FALSE}
lounge1 = filter(lounge, !is.na(cleanliness_rating))
airport1 = filter(airport, !is.na(terminal_cleanliness_rating))

lounge1$airport = str_to_lower(lounge1$airport)
airport1$airport_name = str_replace_all(airport1$airport_name, "-", " ")
airport1 = airport1 %>% rename(airport = airport_name)

lounge1$lounge_name = str_to_lower(lounge1$lounge_name)
lounge1$lounge_name = str_remove_all(lounge1$lounge_name, "review")
lounge1$lounge_name = str_remove_all(lounge1$lounge_name, "customer")

lounge1$lounge_name = as.factor(lounge1$lounge_name)
airport1$airport = as.factor(airport1$airport)

lounge1 = lounge1 %>% group_by(lounge_name, airport) %>% summarise(lounge_mean_clean = mean(cleanliness_rating)) %>% arrange(desc(lounge_mean_clean))
airport1 = airport1 %>% group_by(airport) %>% summarise(airport_mean_clean = mean(terminal_cleanliness_rating)) %>% arrange(desc(airport_mean_clean))

q3 = inner_join(airport1, lounge1, "airport")
q3 = mutate(q3, lounge_cleaner_than_airport = if_else(q3$lounge_mean_clean > q3$airport_mean_clean, 1, 0))
q3 = filter(q3, lounge_cleaner_than_airport == 1)[,-5]


```



**Ответ:** 
  
```{r echo = F}
q3 = q3 %>% rename("полный список лаунж-зон, которые оценены по чистоте выше аэропортов, где они расположены" = "lounge_name")
DT::datatable(q3[,3], 
              rownames = FALSE, 
              options = list(pageLength = 10, scrollX = TRUE), 
              class = 'white-space: nowrap' )
```

**Вывод:** Мы видим, что лаунж-зоны зачастую имеют одинаковые названия, но находятся в разных аэропортах, поэтому можно предположить, что будет полезно дополнительно сгруппировать лаунж-зоны по названиям и/или авиакомпаниям, которым они принадлежат, однако это может привести к тому, что нам придется усреднять оценки чистоты сразу нескольких аэропортов. Также стоит отметить, что возможна погрешность, так как названия лаунж-зон в датасете могут быть указаны по разному, что делает невозможным их группировку, однако при просмотре "вручную" можно заметить, что таких строк не очень много, однако в некоторых случаях непонятно, является предоставленный ответ названием лаунж-зоны или это некорректные данные.
(часть неточностей была устранена за счет "ручной" корректировки)
В целом, видно, что лаунж-зоны достаточно часто оценивают по чистоте выше, чем терминалы аэропортов, где они находятся. Этот результат можно объяснить тем фактом, что лаунж-зоны сами по себе имеют меньший размер, по сравнению с терминалами, поэтому там легче поддерживать порядок, а также, если судить по названиям, обычно лаунж-зоны посещают пассажиры повышенного класса комфортности, их билеты стоят дороже, а значит компания готова предоставлять им более качественный сервис за эту плату. Можно предположить, что аэропорты должны лучше следить за чистотой в терминалах, так как средние оценки чистоты по аэропортам достаточно низкие. С экономической точки зрения, аэропорт стремится минимизировать свои издержки, поэтому склонен экономить на количестве персонала по клинингу, что вполне логично. Авиакомпании же организуют так называемую ценовую дискриминацию, предоставляя пассажирам первого и бизнес классов дополнительный и более качественный сервис. 

### Дэшборд

Полученные выводы обобщены в виде дэшборда со следующими элементами 

**Элемент 1:** 
  - вид: график
- ответ на вопрос: 1
- обоснование: график показывает средние оценки wi-fi по странам, тк в целом оценки не очень высокие, то график представлен за исключением трех лучших оценок. Он позволяет  отразить средние оценки по каждой стране и наглядно сравнить их между собой

**Элемент 2:** 
  - вид: график
- ответ на вопрос: 2
- обоснование: наглядно показывает какие именно оценки и в каком соотношении ставили люди

**Элемент 3:** 
  - вид: таблица
- ответ на вопрос: 2
- обоснование: стандартное сравнение двух чисел, в таблице будут сразу показаны обе категории самолетов и средние значения рейтинга для каждой

**Элемент 4:** 
  - вид: числа
- ответ на вопрос: 4
- обоснование: сразу можем сравнить два числа в абсолютном выражении: количество различных лаунж-зон и количество лаунж-зон, которые по оценкам чистоты превосходят аэропорты, в которых находятся

### Общие выводы

Анализ датасетов позволил ответить на три поставленных вопроса и подумать о том, с какими проблемами сталкиваются пассажиры при авиаперелетах и посещении аэропортов.
Благодаря анализу стало понятно, что в аэропортах скорее всего присутствуют проблемы с wi-fi соединением: большинство респондентов, поставивших оценку по этому параметру, сочли его плохим или средним. Также мы выяснили, что люди практически одинаково оценивают удобство пространства для ног в самолетах с двумя и тремя рядами кресел. Если различия все таки есть, то возможно стоит изучить взаимосвязь оценки, поставленной по критерию «удобство пространства для ног» с длительностью/дальностью полета. Еще возможен вариант сравнения разных моделей самолетов по удобству пространства для ног. Но мне также кажется более полезным сравнить комфортность полета в целом (суммарный или средний рейтинг по различным критериям) для разных самолетов (как по количеству рядов кресел, так и п моделям воздушных судов. Помимо этого, стало понятно, что в половине случаев за чистотой терминалов следят хуже, чем за чистотой лаунж-зон. Это вполне объяснимо тем фактом, что лаунж-зоны являются пространством для пассажиров более высокого класса комфортности, соответственно их билеты стоят дороже (или посещение лаунж-зоны платное), что позволяет выделить больше средств на оплату труда персонала/нанять больше людей. 
Если говорить в целом, то для получения более точной информации и формирования конкретных рекомендаций необходимо значительно расширить датасет, так как сейчас в нем достаточно много пустых полей. Мне кажется, что необходимо усовершенствовать сам опрос пассажиров, так как большинство респондентов поделились лишь общим впечатлением, что, безусловно, полезно, однако не дает возможность уточнить, какие именно сферы имеют проблемы. 